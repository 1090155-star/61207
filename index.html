<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星際戰鬥機：千發彈幕神話版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #010105;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
            background: #08081a;
            border-radius: 30px;
            box-shadow: 0 0 80px rgba(0, 255, 255, 0.15);
            padding: 25px;
            border: 1px solid rgba(0, 255, 255, 0.1);
            position: relative;
        }

        h1 {
            background: linear-gradient(90deg, #00ffff, #ffea00, #ff00ff);
            background-size: 200% auto;
            animation: shine 4s linear infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.2rem;
            font-weight: 900;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        @keyframes shine {
            to { background-position: 200% center; }
        }

        #gameCanvas {
            background-color: #000;
            border-radius: 15px;
            cursor: none;
            touch-action: none;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 1);
        }

        .stats-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 12px;
        }

        .health-bar-bg {
            width: 200px;
            height: 12px;
            background: #111;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        #healthBar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #00f2fe, #4facfe, #00ffff);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .controls {
            margin-top: 15px;
            color: #666688;
            font-size: 0.8rem;
            text-align: center;
        }

        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .btn-restart {
            margin-top: 30px;
            padding: 15px 45px;
            background: linear-gradient(45deg, #00ffff, #ff00ff);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-restart:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
    </style>
</head>
<body>

<div class="game-container">
    <div id="screenShake" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        <h1>GALAXY STRIKE: 1053 BULLETS</h1>

        <div class="stats-bar">
            <div>得分: <span id="scoreDisplay" class="text-cyan-400">0</span></div>
            <div class="flex flex-col items-center">
                <span class="text-[10px] font-bold text-cyan-300 mb-1">神話裝甲 (HP: <span id="hpText">3000</span>/3000)</span>
                <div class="health-bar-bg">
                    <div id="healthBar"></div>
                </div>
            </div>
            <div>最高紀錄: <span id="highScoreDisplay" class="text-pink-400">0</span></div>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div class="controls">
            [WASD] 移動 | [SPACE] 1053發超飽和彈幕 | 重裝甲 3000 HP 已就緒
        </div>
    </div>
</div>

<div id="gameOverModal" class="modal">
    <div class="text-center p-10 border border-cyan-900 rounded-3xl bg-black">
        <h2 class="text-5xl font-black text-white mb-4">任務結束</h2>
        <p class="text-xl text-cyan-500 mb-8">最終積分: <span id="finalScore">0</span></p>
        <button id="restartButton" class="btn-restart">重新開始</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase 設置 ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'galaxy-strike-mythic-v1';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    let db, auth, userId = null;
    const HIGH_SCORE_PATH = `/artifacts/${appId}/public/data/highscores/global`;
    
    if (Object.keys(firebaseConfig).length > 0) {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) userId = user.uid;
                else {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                }
                fetchHighScore();
            });
        } catch(e) { console.error("Firebase init failed", e); }
    }

    let highScore = 0;
    async function fetchHighScore() {
        if (!db) return;
        try {
            const snap = await getDoc(doc(db, HIGH_SCORE_PATH));
            if (snap.exists()) {
                highScore = snap.data().score || 0;
                document.getElementById('highScoreDisplay').textContent = highScore;
            }
        } catch(e) { console.warn("Score fetch failed"); }
    }

    // --- 遊戲引擎核心 ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const WIDTH = 600, HEIGHT = 450;
    canvas.width = WIDTH; canvas.height = HEIGHT;

    // 狀態設定
    const MAX_HEALTH = 3000;
    let score = 0, health = MAX_HEALTH, isGameOver = false, shieldTime = 0, shakeTime = 0;
    let stars = [], bullets = [], enemies = [], particles = [], powerUps = [], floatingTexts = [];
    let boss = null, bossSpawnScore = 8000;
    let slowMoTime = 0, doubleFireTime = 0, rapidFireTime = 0;

    // 彈幕設定：526對 = 1052 + 中央1 = 1053發
    const BULLET_PAIRS = 526; 
    const BULLET_STEP = 1.1; 

    function initStars() {
        stars = Array.from({length: 60}, () => ({
            x: Math.random() * WIDTH,
            y: Math.random() * HEIGHT,
            size: Math.random() * 1.5,
            speed: Math.random() * 1 + 0.1,
            isMeteors: Math.random() < 0.05
        }));
    }

    const player = {
        x: WIDTH / 2, y: HEIGHT - 60,
        w: 30, h: 36, speed: 7, tilt: 0,
        draw() {
            if (isGameOver) return;
            ctx.save();
            ctx.translate(this.x, this.y);
            
            // 護盾視覺效果
            if (shieldTime > 0) {
                ctx.beginPath();
                ctx.arc(0, 0, 42, 0, Math.PI * 2);
                ctx.strokeStyle = shieldTime > 120 ? '#00ffff' : `rgba(0, 255, 255, ${Math.sin(Date.now()/50)*0.5+0.5})`;
                ctx.lineWidth = 4; ctx.stroke();
            }

            ctx.rotate(this.tilt);
            // 引擎火焰
            const flameH = Math.random() * 10 + 5;
            const grad = ctx.createLinearGradient(0, 10, 0, 10 + flameH);
            grad.addColorStop(0, rapidFireTime > 0 ? '#ffea00' : '#00ffff'); 
            grad.addColorStop(1, 'transparent');
            ctx.fillStyle = grad;
            ctx.fillRect(-5, 15, 10, flameH);

            // 戰機主體
            ctx.fillStyle = '#ffffff';
            ctx.shadowBlur = 20; ctx.shadowColor = rapidFireTime > 0 ? '#ff0' : '#0ff';
            ctx.beginPath();
            ctx.moveTo(0, -this.h/2);
            ctx.lineTo(-this.w/2, this.h/2);
            ctx.lineTo(this.w/2, this.h/2);
            ctx.fill();
            ctx.restore();
        }
    };

    function triggerShake() { shakeTime = 15; }

    function spawnFloatingText(x, y, text, color) {
        floatingTexts.push({ x, y, text, color, life: 60 });
    }

    function createExplosion(x, y, color, count = 12) {
        for (let i = 0; i < count; i++) {
            particles.push({
                x, y,
                vx: (Math.random() - 0.5) * 8,
                vy: (Math.random() - 0.5) * 8,
                life: 30, color
            });
        }
    }

    function fire() {
        if (isGameOver) return;
        const h = (Date.now() * 0.1) % 360;
        const bY = player.y - 20;
        const bX = player.x;
        
        const spawnBullets = (xPos) => {
            // 中央主要子彈
            bullets.push({x: xPos, y: bY, c: rapidFireTime > 0 ? '#ffea00' : `hsl(${h}, 100%, 70%)`});
            // 1052發兩側子彈
            for (let i = 1; i <= BULLET_PAIRS; i++) {
                const offset = i * BULLET_STEP;
                const c = rapidFireTime > 0 ? '#ffea00' : `hsl(${(h + i * 0.5) % 360}, 100%, 70%)`;
                bullets.push({x: xPos - offset, y: bY, c});
                bullets.push({x: xPos + offset, y: bY, c});
            }
        };

        if (doubleFireTime > 0) {
            spawnBullets(bX - 25);
            spawnBullets(bX + 25);
        } else {
            spawnBullets(bX);
        }
    }

    let keys = {};
    window.onkeydown = e => { 
        keys[e.key] = true; 
        if(e.key === ' ' && !isGameOver) fire(); 
    };
    window.onkeyup = e => keys[e.key] = false;

    function update() {
        if (isGameOver) return;

        // 狀態更新
        if (slowMoTime > 0) slowMoTime--;
        if (doubleFireTime > 0) doubleFireTime--;
        if (rapidFireTime > 0) {
            rapidFireTime--;
            if (rapidFireTime % 5 === 0) fire(); 
        }
        if (shieldTime > 0) shieldTime--;

        // 移動邏輯
        if (keys.a || keys.ArrowLeft) { player.x -= player.speed; player.tilt = -0.15; }
        else if (keys.d || keys.ArrowRight) { player.x += player.speed; player.tilt = 0.15; }
        else { player.tilt = 0; }
        if (keys.w || keys.ArrowUp) player.y -= player.speed;
        if (keys.s || keys.ArrowDown) player.y += player.speed;

        player.x = Math.max(20, Math.min(WIDTH-20, player.x));
        player.y = Math.max(20, Math.min(HEIGHT-20, player.y));

        // 螢幕震動
        if (shakeTime > 0) {
            const dx = (Math.random() - 0.5) * 10;
            const dy = (Math.random() - 0.5) * 10;
            const container = document.getElementById('screenShake');
            if (container) container.style.transform = `translate(${dx}px, ${dy}px)`;
            shakeTime--;
        } else {
            const container = document.getElementById('screenShake');
            if (container) container.style.transform = `translate(0, 0)`;
        }

        // 子彈與粒子移動
        bullets.forEach(b => b.y -= 13);
        bullets = bullets.filter(b => b.y > -20);
        particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life--; });
        particles = particles.filter(p => p.life > 0);
        floatingTexts.forEach(t => { t.y -= 0.5; t.life--; });
        floatingTexts = floatingTexts.filter(t => t.life > 0);

        // Boss 邏輯
        if (!boss && score >= bossSpawnScore) {
            boss = { x: WIDTH/2, y: -100, hp: 6000, maxHp: 6000, targetX: WIDTH/2, moveTimer: 0 };
            spawnFloatingText(WIDTH/2, 100, "傳奇級 BOSS 現身！", "#ff0000");
        }

        if (boss) {
            if (boss.y < 80) boss.y += 1;
            else {
                boss.moveTimer--;
                if (boss.moveTimer <= 0) {
                    boss.targetX = Math.random() * (WIDTH-200) + 100;
                    boss.moveTimer = 120;
                }
                boss.x += (boss.targetX - boss.x) * 0.05;
                if (Math.random() < 0.1) { 
                    enemies.push({ x: boss.x + (Math.random()-0.5)*150, y: boss.y + 40, hp: 20, maxHp: 20, s: 4, isBossMinion: true });
                }
            }
        }

        // 敵人生成
        const spawnRate = boss ? 0.05 : 0.22;
        if (Math.random() < spawnRate) {
            enemies.push({ 
                x: Math.random() * (WIDTH-40) + 20, 
                y: -20, 
                hp: 25, maxHp: 25, 
                s: (1.5 + score / 12000) * (slowMoTime > 0 ? 0.3 : 1)
            });
        }

        // 碰撞檢測
        for (let ei = enemies.length - 1; ei >= 0; ei--) {
            const e = enemies[ei];
            e.y += e.s;
            
            if (Math.hypot(player.x - e.x, player.y - e.y) < 30) {
                if (shieldTime <= 0) { health -= 15; triggerShake(); }
                enemies.splice(ei, 1);
                createExplosion(e.x, e.y, '#ff3366');
                continue;
            }

            for (let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i];
                if (Math.abs(b.x - e.x) < 25 && Math.abs(b.y - e.y) < 25) {
                    e.hp--; 
                    bullets.splice(i, 1);
                    if (e.hp <= 0) {
                        enemies.splice(ei, 1);
                        score += 150;
                        createExplosion(e.x, e.y, '#ff3366');
                        break;
                    }
                }
            }
            if (e && e.y > HEIGHT) { enemies.splice(ei, 1); if (shieldTime <= 0) health -= 5; }
        }

        // Boss 碰撞檢測
        if (boss) {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i];
                if (Math.abs(b.x - boss.x) < 70 && Math.abs(b.y - boss.y) < 50) {
                    boss.hp -= (rapidFireTime > 0 ? 0.6 : 0.4);
                    bullets.splice(i, 1);
                    if (boss.hp <= 0) {
                        createExplosion(boss.x, boss.y, '#ffaa00', 100);
                        score += 50000;
                        boss = null;
                        bossSpawnScore += 100000;
                        triggerShake();
                        spawnFloatingText(WIDTH/2, HEIGHT/2, "傳奇終結！", "#00ffff");
                        for(let k=0; k<5; k++) powerUps.push({x: WIDTH/2 + (k-2)*40, y: 100, type: Math.floor(Math.random()*6)});
                        break;
                    }
                }
            }
        }

        // 道具更新
        if (Math.random() < 0.012) powerUps.push({x: Math.random()*(WIDTH-40)+20, y: -20, type: Math.floor(Math.random()*6)});
        
        for (let pi = powerUps.length - 1; pi >= 0; pi--) {
            const p = powerUps[pi];
            p.y += 2.5;
            if (Math.hypot(player.x - p.x, player.y - p.y) < 25) {
                if (p.type === 0) { health = Math.min(MAX_HEALTH, health + 800); spawnFloatingText(p.x, p.y, "+800HP", "#00ff88"); }
                if (p.type === 1) { slowMoTime = 400; spawnFloatingText(p.x, p.y, "時空凍結", "#aaaaff"); }
                if (p.type === 2) { doubleFireTime = 500; spawnFloatingText(p.x, p.y, "雙重火力", "#ff00ff"); }
                if (p.type === 3) { shieldTime = 600; spawnFloatingText(p.x, p.y, "無敵護盾", "#ffff00"); }
                if (p.type === 4) { triggerShake(); enemies.forEach(e => { createExplosion(e.x, e.y, '#ffffff'); score += 100; }); enemies = []; spawnFloatingText(p.x, p.y, "超核爆彈！", "#ff5500"); }
                if (p.type === 5) { rapidFireTime = 400; spawnFloatingText(p.x, p.y, "超高速連射", "#ffea00"); }
                powerUps.splice(pi, 1);
            }
            else if (p.y > HEIGHT) powerUps.splice(pi, 1);
        }

        // 遊戲結束判定
        if (health <= 0) {
            isGameOver = true;
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOverModal').style.display = 'flex';
            if (db && score > highScore) setDoc(doc(db, HIGH_SCORE_PATH), { score, userId, time: Date.now() }, { merge: true }).catch(() => {});
        }
        
        // UI 更新
        document.getElementById('scoreDisplay').textContent = score;
        document.getElementById('hpText').textContent = Math.max(0, Math.floor(health));
        document.getElementById('healthBar').style.width = (Math.max(0, health) / MAX_HEALTH * 100) + '%';
    }

    function draw() {
        ctx.fillStyle = '#010105'; ctx.fillRect(0, 0, WIDTH, HEIGHT);

        stars.forEach(s => {
            ctx.fillStyle = s.isMeteors ? '#fff' : `rgba(255,255,255,${s.speed/2})`;
            const size = s.isMeteors ? 1 : s.size;
            ctx.fillRect(s.x, s.y, size, s.isMeteors ? 10 : size);
            s.y += (s.isMeteors ? s.speed * 5 : s.speed) * (slowMoTime > 0 ? 0.5 : 1);
            if(s.y > HEIGHT) s.y = -10;
        });

        // 渲染 1053 發子彈
        bullets.forEach(b => { 
            ctx.fillStyle = b.c; 
            ctx.fillRect(b.x, b.y, 0.8, 10); 
        }); 

        // 渲染 Boss
        if (boss) {
            ctx.strokeStyle = '#ffff00'; ctx.lineWidth = 4;
            ctx.strokeRect(boss.x - 60, boss.y - 30, 120, 60);
            ctx.fillStyle = 'rgba(255, 255, 0, 0.1)';
            ctx.fillRect(boss.x - 58, boss.y - 28, 116, 56);
            ctx.fillStyle = '#222'; ctx.fillRect(boss.x - 60, boss.y - 45, 120, 5);
            ctx.fillStyle = '#ff0'; ctx.fillRect(boss.x - 60, boss.y - 45, (boss.hp/boss.maxHp)*120, 5);
        }

        // 渲染敵人
        enemies.forEach(e => {
            ctx.strokeStyle = e.isBossMinion ? '#0ff' : '#ff3366'; ctx.lineWidth = 2;
            ctx.strokeRect(e.x-12, e.y-12, 24, 24);
            ctx.fillStyle = e.isBossMinion ? '#003344' : '#440011'; ctx.fillRect(e.x-12, e.y-18, 24, 3);
            ctx.fillStyle = e.isBossMinion ? '#0ff' : '#ff3366'; ctx.fillRect(e.x-12, e.y-18, (e.hp/e.maxHp) * 24, 3);
        });

        particles.forEach(p => { ctx.fillStyle = p.color; ctx.globalAlpha = p.life / 30; ctx.fillRect(p.x, p.y, 2, 2); });
        ctx.globalAlpha = 1;

        floatingTexts.forEach(t => { ctx.fillStyle = t.color; ctx.font = 'bold 14px sans-serif'; ctx.textAlign = "center"; ctx.fillText(t.text, t.x, t.y); });

        powerUps.forEach(p => {
            const colors = ['#0f8', '#88f', '#f0f', '#ff0', '#f50', '#fea'];
            ctx.fillStyle = colors[p.type]; 
            ctx.beginPath(); ctx.arc(p.x, p.y, 12, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = '#fff'; ctx.font = 'bold 12px sans-serif'; ctx.textAlign = 'center';
            const icons = ['H', 'S', 'D', 'G', 'B', 'R'];
            ctx.fillText(icons[p.type], p.x, p.y + 4);
        });

        player.draw();
    }

    function loop() { 
        update(); 
        draw(); 
        requestAnimationFrame(loop); 
    }
    
    document.getElementById('restartButton').onclick = () => location.reload();
    initStars(); 
    loop();
</script>
</body>
</html>